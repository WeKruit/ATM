name: CD â†’ ATM Dashboard (Fly.io)

on:
    workflow_dispatch:
    push:
        branches: [main]
        paths:
            - "atm-dashboard/**"

concurrency:
    group: deploy-atm-dashboard
    cancel-in-progress: false

jobs:
    ci:
        uses: ./.github/workflows/ci-atm.yml
        secrets: inherit

    deploy:
        name: Deploy to Fly.io
        needs: ci
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - uses: actions/checkout@v4

            - uses: superfly/flyctl-actions/setup-flyctl@master

            - name: Deploy atm-dashboard
              run: flyctl deploy --remote-only
              working-directory: atm-dashboard
              env:
                  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

            - name: Deploy summary
              if: always()
              run: |
                  echo "### ATM Dashboard Deploy" >> $GITHUB_STEP_SUMMARY
                  echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| App | atm-wekruit |" >> $GITHUB_STEP_SUMMARY
                  echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
