service: ghosthands
image: ghosthands

require_destination: true
minimum_version: 2.0.0
retain_containers: 5
deploy_timeout: 120
drain_timeout: 30
readiness_delay: 7

servers:
  web:
    hosts: []
    cmd: packages/ghosthands/src/api/server.ts
    labels:
      gh.service: api
      gh.managed: "true"
    options:
      entrypoint: /usr/local/bin/bun
      publish:
        - 3100:3100
    proxy: false
  workers:
    hosts: []
    cmd: packages/ghosthands/src/workers/main.ts
    labels:
      gh.service: worker
      gh.managed: "true"
    options:
      entrypoint: /usr/local/bin/bun
      publish:
        - 3101:3101
        - 6901:6901
    proxy: false

builder:
  arch: amd64

registry:
  server: 168495702277.dkr.ecr.us-east-1.amazonaws.com
  username: AWS
  password:
    - KAMAL_REGISTRY_PASSWORD

ssh:
  user: ubuntu
  keys:
    - /root/.ssh/gh-deploy-key
  keys_only: true
  config: false

env:
  clear:
    NODE_ENV: production
    GH_API_PORT: "3100"
    GH_WORKER_PORT: "3101"
    MAX_CONCURRENT_JOBS: "1"
  secret:
    - GH_ENVIRONMENT
    - DATABASE_URL
    - DATABASE_DIRECT_URL
    - SUPABASE_URL
    - SUPABASE_SECRET_KEY
    - SUPABASE_PUBLISHABLE_KEY
    - REDIS_URL
    - GH_SERVICE_SECRET
    - GH_DEPLOY_SECRET
    - ANTHROPIC_API_KEY
    - DEEPSEEK_API_KEY
    - S3_ENDPOINT
    - S3_ACCESS_KEY
    - S3_SECRET_KEY
    - S3_REGION
    - CORS_ORIGIN
    - VALET_DEPLOY_WEBHOOK_SECRET
    - SILICONFLOW_API_KEY
